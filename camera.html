<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Blank Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        html,
        body {
            width: 100%;
            height: 100%;
        }

        canvas {
            display: block;
            background-color: black;
        }
    </style>
</head>

<body oncontextmenu="return false;">
    <canvas id="canvas"></canvas>
    <script src="code/loop.js"></script>
    <script src="code/basic.js"></script>
    <script src="code/ecs.js"></script>
    <script src="code/camera.js"></script>
    <script src="code/input.js"></script>
    <script>
        var canvas = document.getElementById("canvas");
        var ctx = canvas.getContext("2d");

        window.addEventListener("resize", resizeCanvas, false);

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            scene.camera.width = canvas.width;
            scene.camera.height = canvas.height;
        }

        window.addEventListener("keypress", doKeyDown, false);

        function doKeyDown(e) {
            if (e.keyCode == 47) {
                for (var i = 0; i < scene.entities.length; i++) {
                    scene.entities[i].motion.acceleration = new Vector(Random.float(-0.0001, 0.0001), Random.float(-0.0001, 0.0001));
                }
            }
            if (e.keyCode == 46) {
                if (!scene.entityToFollow)
                    scene.entityToFollow = 0;
                scene.entities[scene.entityToFollow].getComponent("Shape").highlight = false;
                scene.entityToFollow = scene.entityToFollow >= scene.entities.length - 1 ? 0 : scene.entityToFollow + 1;
                scene.entities[scene.entityToFollow].getComponent("Shape").highlight = true;
                scene.camera.targetPosition = scene.entities[scene.entityToFollow].transform.position;
            }
        }

        class Scene {
            constructor() {
                this.width = 2600;
                this.height = 2000;
                this.entities = [];
                this.entityToFollow = null;
                this.movementSystem = new MovementSystem(this.width, this.height);
                this.camera = new Camera(canvas.width, canvas.height);
                this.shapeRendererSystem = new ShapeRendererSystem();
                this.traceRendererSystem = new TraceRendererSystem();
                this.input = new Input();
                this.runUpdate = true;
            }

            update(delta) {
                if (Input.instance.isKeyDown("NumpadMultiply"))
                    this.entityToFollow = null;

                if (this.runUpdate) {
                    this.movementSystem.update(delta, this.entities);
                    this.traceRendererSystem.update(delta, this.entities);
                }

                this.camera.update(delta);

                if (Input.instance.isKeyDown("Space"))
                    this.runUpdate = !this.runUpdate;
            }

            draw(interp) {
                // Clear canvas and save 
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.save();

                // Zoom camera according to scale
                ctx.scale(this.camera.zoom, this.camera.zoom);

                // Center world in canvas
                ctx.translate(canvas.width / (2 * this.camera.zoom), canvas.height / (2 * this.camera.zoom));

                // Scroll camera center
                ctx.translate(-1 * this.camera.position.x, -1 * this.camera.position.y);

                this.shapeRendererSystem.draw(interp, ctx, this.entities);
                this.traceRendererSystem.draw(interp, ctx, this.entities);

                // World edges
                ctx.beginPath();
                ctx.strokeStyle = Color.fixedStyle(0, 0, 100, 0.5);
                ctx.lineWidth = 2;
                ctx.rect(0 - Math.round(this.width / 2), 0 - Math.round(this.height / 2), this.width, this.height);
                ctx.stroke();

                // Restore to draw relative to window edges
                ctx.restore();

                // FPS
                ctx.fillStyle = new Color(0, 0, 100, 0.5).style;
                ctx.font = "12px monospace";
                ctx.textBaseline = "top";
                ctx.textAlign = "right";
                ctx.fillText(Math.round(loop.getFPS()) + " FPS", canvas.width - 20, 20);

                ctx.textAlign = "left";
                ctx.fillText("Canvas: " + canvas.width + "x" + canvas.height, 20, 20);

                // Screen to World Test
                var cursorPosition = Input.instance.mousePosition;
                var worldPosition = this.camera.screenToWorldPoint(cursorPosition);
                ctx.fillText("Screen position: " + cursorPosition.x + "x" + cursorPosition.y, cursorPosition.x + 20, cursorPosition.y - 10);
                ctx.fillText("Cursor position: " + worldPosition.x.toFixed(2) + "x" + worldPosition.y.toFixed(2), cursorPosition.x + 20, cursorPosition.y + 10);

            }
        }

        function update(delta) {
            scene.update(delta);
        }

        function draw(interp) {
            scene.draw(interp);
        }

        var scene = new Scene();
        var loop = new Loop().setUpdate(update).setDraw(draw).start();
        resizeCanvas();

        // Random entities
        for (var i = 0; i < 50; i++) {
            var entity = new Entity();
            var position = new Vector(Random.float(-100, 100), Random.float(-100, 100));
            entity.addComponent(new TransformComponent(position));
            var velocity = new Vector(Random.float(-0.1, 0.1), Random.float(-0.1, 0.1));
            var maxVelocity = Random.float(0.5, 0.5);
            var acceleration = new Vector(Random.float(-0.0001, 0.0001), Random.float(-0.0001, 0.0001));
            entity.addComponent(new MotionComponent(velocity, maxVelocity, acceleration));
            var color = Color.fixedStyle(Random.value([0, 60, 100, 250]), 100, 60, 1);
            entity.addComponent(new ShapeComponent(6, 6, color));
            entity.addComponent(new TraceComponent(1, color));
            scene.entities.push(entity);
        }

    </script>
</body>

</html>